---
layout: post
title:  "此情可待成追忆，吃饭睡觉PhD"
---
<!DOCTYPE html>
<html>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<head>
</head>
<body>
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="http://colorbrewer2.org/export/colorbrewer.js"></script>
  <script src="http://dimplejs.org/dist/dimple.v2.0.0.min.js"></script>
  <style type="text/css">
    #svg-map {
      margin:10px 10px 0 10px;
      border:2px solid #000;
      border-radius: 5px;
      overflow:hidden;
      width: 98%;
    }

    #legend-menu {
      width: 98%;
    }

    select {
      float: right;
    }

    .list-inline {
      padding: 0 0 0 0.5em;
      display: table;
      width: 100%;
      float: left;
      margin-bottom: 0;
      margin-left: 0;
    }

    .key {
      list-style: none;
      text-align: right;
      vertical-align: middle;
      display: inline-block;
      border-top-width: 15px;
      border-top-style: solid;
      font-size: 0.6em;
      width: 5%;
      padding-left: 0;
      padding-right: 0;
    }

    #legend_name {
      width: 10em;
    }

    #maptip {
      position: absolute;
      z-index: 10;
      visibility: hidden;
      -moz-transition: all 0.15s;
      -o-transition: all 0.15s;
      -webkit-transition: all 0.15s;
      transition: all 0.15s;
      opacity: 0.90;
      min-width: 60px;
      height: auto;
      padding: 10px;
      background-color: white;
      -webkit-border-radius: 5px;
      -moz-border-radius: 5px;
      border-radius: 5px;
      -webkit-box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.4);
      -moz-box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.4);
      box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.4);
      pointer-events: none;
    }

    .box-plot {
      float: left;
      width: 240px;
      margin-right: 30px;
      /*right-padding: 30px;*/
    }

    .axis {
      font: 11px sans-serif;
    }

    .axis path,
    .axis line {
      fill: none;
      stroke: #000;
      shape-rendering: crispEdges;
    }

    .x.axis path {
      display: none;
    }

    .x text {
      /*font-family: sans-serif;*/
      font-size: 14px;
    }

    #boxtip {
      position: absolute;
      z-index: 100;
      visibility: hidden;
      -moz-transition: all 0.15s;
      -o-transition: all 0.15s;
      -webkit-transition: all 0.15s;
      transition: all 0.15s;
      opacity: 0.90;
      min-width: 60px;
      height: auto;
      padding: 10px;
      background-color: white;
      -webkit-border-radius: 5px;
      -moz-border-radius: 5px;
      border-radius: 5px;
      -webkit-box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.4);
      -moz-box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.4);
      box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.4);
      pointer-events: none;
    }

    #legend-title {
      font-size: 0.6em;
      padding-left: 0.6em;
    }

    .chart {
      float: left;
      width: 40%;
      margin-right: 100px;
    }
  </style>
<p>博士毕业了，趁着博客正式开张之际总结一下，顺便帮助那些不了解我的人——包括许多因为认识我一些年而误以为了解我的人——了解我。为这事费点笔墨是值得的，毕竟我的思想背景在中文世界远非主流，因此许多人持有的“因为你人生的某一阶段和我相似所以我们应该是一类人”的朴素观念常常让我感到困扰。</p>
<!-- excerpt break -->

<h2>学业</h2>
<p>化学反应是分子的反应，分子无时无刻不在振动，所以分子的振动理所应当地影响着反应过程。问题是，具体怎么影响的？能用方程写出来吗？</p>
<p>这就是我博士论文的大致领域了。我做的工作可以分为两部分。一是为导师数年前推导的一个化学动力学方程找到了一种无需经验参数的参数化方法。之前他那个方程只能根据实验数据猜下参数，实用性很差，而现在我们可以完全利用量子化学软件算出来的数据进行参数化了，计算出的反应速率在一组经典实验上和实验结果以及其他理论模型(<a href="https://en.wikipedia.org/wiki/Marcus_theory">Marcus theory</a>)计算得到的结果都吻合的不错，算是初步校准了吧。</p>
<figure>
    <img src="/assets/images/tclme_expr.jpg">
    <figcaption>理论和实验数据的对比。除了比较特殊的分子M之外，我们的理论速率和实验结果基本都在一个数量级上。</figcaption>
</figure>
<p>二是——也是更有意义的一个结果——和之前的大部分模型比起来，我们的方法可以直接分析分子振动对动力学的影响。经典物理里我们已经知道分子的振动可以分解为正则振动(<a href="https://en.wikipedia.org/wiki/Normal_mode">normal mode</a>)。一个反应当然所有的正则振动都会参与，但参与程度有多有少，我们的模型似乎能够依次找出最重要的那些振动方式（它们是正则振动的线性组合）。说“似乎”是因为这个方法是基于物理上的一些想法，我还没能得到一般性的数学证明。比如上图里的那些分子，它们的单分子三重态转移(triplet-triplet transfer)都由经典的实验研究过了。这些分子的原子数在40-70不等，所以正则模式都有一两百种，当我们把所有模式的参数都放进方程，那就是上一段所说的结果——和实验数据吻合。但我们还有办法找出一个“主模式”，仅仅把它放入方程就足以得出几乎一样的反应速率，也就是说这个主模式完全主宰了反应，这就是我的第一篇论文。</p>
<figure>
    <img width=80% src="/assets/images/c14ee.jpg">
    <img src="/assets/images/c14ee.gif">
    <img width=80% src="/assets/images/d26ae.jpg">
    <img src="/assets/images/d26ae.gif">
    <figcaption>两个有代表性的分子(c-1,4ee和d-2,6ae)三重态转移过程的主模式。</figcaption>
</figure>
<p>不难看出主模式在局部具有很高的对称性，进一步分析会得到一些对反应过程更深的理解，这就是第二篇论文。之后与一个实验组合作，把这方法应用到另一组很有趣的分子上去，一通分析后是正在写的第三篇论文。</p>
<p>原则上这个模型适用于任何单分子反应，对理解诸如有机太阳能电池材料的性质、生化里的各种反应都可以有帮助。当然生活不会那么美好，确实已经遇到一些失败的情况，原因还在研究中……</p>
<p>总的来说在平均水平以上吧，算不上一流的研究，但在这学校也还可以敝帚自珍一下。如果你感兴趣，这是我的<a href="https://rawgit.com/tcya/PhD-thesis/master/thesis.pdf">博士论文</a>。</p>

<h2>主业</h2>
<p>人类的语言能力出类拔萃，那问题来了，其他动物有语言吗？当然还是有的，只是比较原始。这个问题的第一个明确证据出现在黑长尾猴(<a href="https://en.wikipedia.org/wiki/Vervet_monkey">vervet monkey</a>)身上。科学家注意到这种猴子看到不同捕食者时似乎会发出不同的声音来警告同伴。它们有三种警报类型：看到老鹰的、蛇的和花豹的。不同的警报会触发不同的反应，比如听到蛇警报猴子们就会往树上跑，而听到鹰警报则会躲到树枝繁茂的地方。灵长类学家用录音机把不同的警报声录下来然后在没有捕食者的时候放给猴子听，发现依然会触发类似反应，这就确证了这些警报声音本身携带着捕食者的信息。我们先来听下它们都是啥样的。
    <div>
        <ul>
            <li>鹰警报
                <audio controls="controls">
                  <source src="/assets/images/eagle.mp3">
                  <source src="/assets/images/eagle.wav">
                Your browser does not support the audio tag.
                </audio>
            </li>
            <li>蛇警报
                <audio controls="controls">
                  <source src="/assets/images/snake.mp3">
                  <source src="/assets/images/snake.wav">
                Your browser does not support the audio tag.
                </audio>
            </li>
            <li>花豹警报
                <audio controls="controls">
                  <source src="/assets/images/leopard.mp3">
                  <source src="/assets/images/leopard.wav">
                Your browser does not support the audio tag.
                </audio>
            </li>
        </ul>
    </div>
</p>
<p>大部分人应该直接就能听出区别。它们的频谱也确实不一样。从频谱图上可以看出蛇警报高频成分很多，听着也确实比较尖锐，不信你再听一遍。</p>
<figure>
    <img style="float:left;width:32%" src="/assets/images/eagle_spectrogram.png">
    <img style="float:left;width:32%" src="/assets/images/snake_spectrogram.png">
    <img style="float:left;width:32%;" src="/assets/images/leopard_spectrogram.png">
    <figcaption style="clear: both">三幅图依次为鹰、蛇和花豹警报。横轴是时间，纵轴是频率，颜色的深浅就代表那个时刻的声音在某个频率上有多大的分量。中图明显在频域上更广。<a href="http://www.psych.upenn.edu/~seyfarth/Baboon%20research/vervet%20vox.htm">图片来源</a></figcaption>
</figure>
<p>这是区别比较明显的情况，要是遇上灵长类学家也莫衷一是该怎么办？我们能不能让电脑来当裁判？为了解决这问题，我在网上找了个关于黑长尾猴警报的<a href="http://www.arkive.org/vervet/chlorocebus-pygerythrus/video-11a.html">视频</a>，提出音轨，然后把相应的警报声剪出来让电脑分类。想法是这样的：电脑在分类时是不知道这些音频对应着什么警报的（用机器学习的黑话这叫<a href="https://zh.wikipedia.org/zh-cn/非監督式學習">非监督式学习</a>），假如电脑分成三类得到的结果与灵长类学家的观察结果吻合，那就说明这方法是对头的。</p>
<p>我测试了三种分类算法：<a href="http://scikit-learn.org/stable/modules/mixture.html">Gaussian mixture model</a>、<a href="https://en.wikipedia.org/wiki/K-means_clustering">k-means</a>和Partitioning Around Medoids (<a href="https://en.wikipedia.org/wiki/K-medoids#Algorithms">PAM</a>)，k-means和PAM得到的结果都不错，至少有70%的数据被正确的归类了，下表显示了每类中有多少数据点。</p>
<style type="text/css">
.tg  {border-collapse:collapse;border-spacing:0;}
.tg td{font-family:Arial, sans-serif;font-size:14px;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;}
.tg th{font-family:Arial, sans-serif;font-size:14px;font-weight:normal;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;}
.tg .tg-e3zv{font-weight:bold}
.tg .tg-yw4l{vertical-align:top}
</style>
<table style="float:left;margin-bottom: 15px;" class="tg">
  <tr>
    <th class="tg-e3zv">k-means</th>
    <th class="tg-yw4l">类1</th>
    <th class="tg-yw4l">类2</th>
    <th class="tg-yw4l">类3</th>
  </tr>
  <tr>
    <td class="tg-yw4l">蛇</td>
    <td class="tg-yw4l">0</td>
    <td class="tg-yw4l">1</td>
    <td class="tg-yw4l">195</td>
  </tr>
  <tr>
    <td class="tg-yw4l">鹰</td>
    <td class="tg-yw4l">0</td>
    <td class="tg-yw4l">185</td>
    <td class="tg-yw4l">56</td>
  </tr>
  <tr>
    <td class="tg-yw4l">花豹</td>
    <td class="tg-yw4l">101</td>
    <td class="tg-yw4l">4</td>
    <td class="tg-yw4l">36</td>
  </tr>
</table>
<table style="float:left;margin-left: 15px;" class="tg">
  <tr>
    <th class="tg-e3zv">PAM</th>
    <th class="tg-yw4l">类1</th>
    <th class="tg-yw4l">类2</th>
    <th class="tg-yw4l">类3</th>
  </tr>
  <tr>
    <td class="tg-yw4l">蛇</td>
    <td class="tg-yw4l">185</td>
    <td class="tg-yw4l">11</td>
    <td class="tg-yw4l">0</td>
  </tr>
  <tr>
    <td class="tg-yw4l">鹰</td>
    <td class="tg-yw4l">32</td>
    <td class="tg-yw4l">209</td>
    <td class="tg-yw4l">0</td>
  </tr>
  <tr>
    <td class="tg-yw4l">花豹</td>
    <td class="tg-yw4l">20</td>
    <td class="tg-yw4l">13</td>
    <td class="tg-yw4l">108</td>
  </tr>
</table>
<p style="clear:left">这就说明这种音频处理方法是有效的，于是我们就可以转向<a href="https://zh.wikipedia.org/zh-cn/監督式學習">监督式学习</a>，即这次我们告诉电脑每个输入音频是什么警报，从而训练一个模型，这个模型就能够用来推测一个未知音频最可能是什么含义。我尝试了<a href="https://zh.wikipedia.org/zh-cn/支持向量机">支持向量机</a>，
<a href="https://zh.wikipedia.org/zh-cn/决策树学习">决策树</a>，
<a href="https://zh.wikipedia.org/zh-cn/AdaBoost">AdaBoost</a>，
和<a href="https://zh.wikipedia.org/zh-cn/朴素贝叶斯分类器#.E9.AB.98.E6.96.AF.E6.9C.B4.E7.B4.A0.E8.B4.9D.E5.8F.B6.E6.96.AF">高斯朴素贝叶斯</a>方法。除了支持向量机之外的方法都得到了>90%的准确率。决策树和AdaBoost表现的最好，在精细调参后分别可以得到97%和99%的准确率（源代码和音频处理的技术细节见我的<a href="https://github.com/tcya/Vervet-monkey-alarm-clustering">GitHub</a>）。想象一下，假如我们能把它做成一个app，那灵长类学家在野外拿着手机录下一段声音后app就会告诉你这段声音最可能是什么警报，这不就是一个初级的动物语言翻译器了吗？</p>
<p>这套方法显然也可以用到其他动物身上，蛙叫鸟鸣都不成问题。考虑到世界上有那么多会发出声音的动物，简直前途无量，这么简单的方法不会之前都没人想到吧……于是我赶紧去检索了下文献，结果发现居然只有一篇类似的<a href="http://www.nature.com/articles/srep13220">论文</a>。但太类似了，类似到数据都用的是黑长尾猴。虽然只比我早不到一年，但我毕竟不是第一个了……唉，错过了开创一个四级学科的机会，只好等下次了●︿●</p>
<p>虽然没能开创一个新领域，不过这个例子很好地说明了我这些年的生活状态。了解我这边生活的人都知道我几乎不去学校，六年下来在实验室的日子应该不会超过一学期，大部分时间都是这样在家里东搞西搞。这些年大脑版本确实又升级了几次，但跟博士学习大概关系不大……读博的主要好处就是让我能有够用的工资和时间瞎折腾罢了。</p>

<h2>职业</h2>
<p>家长经常担心孩子玩物丧志影响学习。我小的时候他们担心看电视，现在大概是担心玩电脑和手机。但这种担忧有数据支持吗？为此我找来了国际学生能力评估计划(<a href="https://zh.wikipedia.org/zh-cn/国际学生能力评估计划">PISA</a>)2012年的数据。PISA不仅测试了各国孩子的成绩，还统计了诸如家里有几辆车、几间厕所、几台电脑手机等等。多一台电脑在穷国和富国的含义可能截然不同，所以我按人均GDP < $15000、$15000到30000、> $30000分出低中高收入地区的数据，然后研究了一下相关性。假如学生成绩随着财富拥有量的增多而提高，就是正相关(positive)，反之负相关(negative)，否则不显著(insignificant)。</p>
<figure>
    <img style="float:left;" src="/assets/images/PISA_cell.png">
    <img style="float:left;" src="/assets/images/PISA_pc.png">
    <figcaption style="clear: both">不同颜色的线代表不同的人均GDP水平。第一幅图是关于手机的，第二幅是关于电脑的。可以看出二者在任何国家几乎都不与成绩负相关，尤其是电脑，几乎在哪都与成绩正相关。</figcaption>
</figure>
<p style="font-size:14px;">点击下方地图或者在下拉列表里选择即可查看相应地区的数据</p>
<div id='pisa'></div>
<p style="clear:both;">虽然这只是相关性，不是因果性，但在情况各异的那么多国家都呈现出如此强烈的相关性，至少先让我们对玩电脑丧志假说打上个问号吧。</p>
<p>这其实是我之前参加Udacity的<a href="https://www.udacity.com/course/data-analyst-nanodegree--nd002">Data Analyst Nanodegree</a>时做的一个项目，完整版在<a href="http://bl.ocks.org/tcya/4cd4f0dbc263310f0de62e4859f170c0">这里</a>。如Google首席经济学家范里安所说：</p>
<blockquote>If you are looking for a career where your services will be in high demand, you should find something where you provide a scarce, complementary service to something that is getting ubiquitous and cheap. So what’s getting ubiquitous and cheap? Data. And what is complementary to data? Analysis.</blockquote>
<p>数据分析确实是个会快速增长的行业，而且像这样从数据中寻找对世界的理解也非常的有意思。于是我就花了点时间学习了一下，最终顺利去了Google。如果你也有这方面的打算，我的部分<a href="https://mp.weixin.qq.com/s?__biz=MzI0NzE3NTAzOA==&mid=404480241&idx=1&sn=5d593f83c993ff658a0c7675730b0059&scene=0&uin=NTUxMjYxMDk1&key=77421cf58af4a65359ab428848afed02a936456e3ed95a60cd6aaa092aa4f66aa8571051d278576cbf788e8ba2168fea&devicetype=iMac+MacBookPro10%2C1+OSX+OSX+10.11.5+build(15F34)&version=11020201&lang=zh_CN&pass_ticket=veiQcItDy6wRkYGuG%2BgafhKSL2%2F3NegXTF7KnSzZnmWtaHV5%2BTFG31rdeg9M%2B4SK">学习经历</a>也许对你能有所帮助。</p>

<h2>笑柄</h2>
<p>他隐忍数十年，终于当上总统，任内借机废止了动勘，推动了议会和总统民选，和平实现了政党轮替，还成功<a href="https://zh.wikipedia.org/zh-cn/台灣海峽飛彈危機">测出</a>对岸的色厉内荏，保小岛平安至今，台湾自由化的每一步几乎都有他的身影。他就是李登辉，华人世界少见的政治家。</p>
<p>从这段评价不难看出我的政治观点和大多数人很不一样。我完全理解此类观点在天朝的罕有和后果，并且完全乐意接受它。考虑到我一贯深思熟虑的风格，我不认为一般人有能力改变我，所以就不要来费这个劲了，我过得挺好的……就如辉格所说，我们这些人是注定要成为笑柄的，那就做一个热情的看客，或恬淡的笑柄吧~</p>
<figure>
    <img src="/assets/images/Malthus.png">
    <figcaption>在最简化的层次上，人类历史就两个阶段：工业革命前的马尔萨斯陷阱时期和之后的大分流(<a href="https://en.wikipedia.org/wiki/Great_Divergence">Great Divergence</a>)。这幅图有助于思考此类问题：人类在99.9%的时间里过着什么样的生活？现代文明是理所当然还是需要努力捍卫的？如果没有大英，今天的世界会是怎样？现代文明的中心在哪，边陲在哪，敌人在哪？有些人津津乐道的汉唐盛世、大国崛起在这幅图上处于什么位置？<a href="https://book.douban.com/subject/3837302/">图片来源</a>、<a href="http://open.163.com/special/opencourse/economichistory.html">配套课程</a></figcaption>
</figure>

<h2>二次元</h2>
<p>这些年看了许多动漫，大部分都没什么意思，只够打发时间，但遇到《银魂》就让我觉得这些都是值得的。虽然最近的漫画有点让人无语，但以前的作品依然让我又哭又笑、<a href="http://ruby.komica.org/html/E6-88-90-E5-8F-A5-2F-E7-8C-A9-E7-8C-A9-E7-8E-A9-E5-BC-84-E8-AE-80-E8-80-85-E7-9A-84-E8-82-A1-E9-96-93-.html">被猩猩玩弄于股间</a>仍欲罢不能(*/ω＼*)</p>
<p>另外两部很喜欢的作品是《灌篮高手》和《星际牛仔》。</p>
<h2>运动</h2>
<p>在酱油队都快踢不上主力了 (;´༎ຶД༎ຶ`)</p>
<p>三分依然很准</p>
<p>有一搭没一搭地健身了n久</p>
<p>并卵</p>
<figure>
    <img src="/assets/images/soccer_me.gif">
</figure>

<h2>未来</h2>
<p>时不时就会有人问我为什么不留在学术圈努力当教授——问这问题的人一般既不理解学术圈也不理解我。我的标准回答是水平不够，这是事实，但其实不是全部。真正的原因就像《纽约客》对张益唐的<a href="http://www.thepaper.cn/newsDetail_forward_1298956">采访</a>里说的，</p>
<blockquote>
  追求终身教职，需要一个学者频繁地发表论文，这通常意味着将研究缩窄到某个特定领域，对此，张益唐没有兴趣。他似乎不想和其他数学家竞争，也不因数年来只是一名普通老师而不满，要知道和他同辈的数学家都是教授了。了解他的人中，没有人认为他适合做终身教授。
</blockquote>
<p>学者其实分为两种，弗里曼·戴森把他们称为<a href="http://news.sciencenet.cn/htmlnews/2011/8/251096-1.shtm">鸟和青蛙</a>，哈耶克则<a href="http://www.aisixiang.com/data/31044.html">称之为</a>“自己专业中的大师”和“困惑型”的人。重点并不在于鸟和青蛙谁厉害——青蛙可以很大只，鸟也可以像我这样还不太会飞；而是二者的学术兴趣和研究方法都很不相同。假如我一心扑在一个小领域上，应该也能在学术圈混口饭吃，但那样的生活对我来说太过无趣了。而如果我既想当鸟又想留在学术圈，难度又太大了。由于<a href="https://zh.wikipedia.org/zh-cn/邓巴数">邓巴数</a>的限制，一个子学科的一线研究者数量约在150左右，其中鸟的数量大概不会超过5，所以学术界留给鸟的位置要比青蛙少很多，我目前是毫无希望的。既然这样，为什么不去工业界当个码农，业余时间继续瞎折腾，还能顺便多赚点钱呢？</p>
<figure>
    <img src="/assets/images/邓巴数.png">
    <figcaption>摘自《<a href="https://book.douban.com/subject/5408894/">你需要多少朋友：神秘的邓巴数字与遗传密码</a>》</figcaption>
</figure>
<p>泡利晚年曾<a href="http://www.changhai.org/articles/science/misc/PauliMistake2.php">这样</a>回顾自己：</p>
<blockquote>年轻时我以为自己是当时最好的形式主义者， 是一个革命者。 当伟大的问题到来时， 我将是解决并书写它们的人。 伟大的问题来了又去了， 别人解决并书写了它们。 我显然是一个古典主义者， 而不是革命者。</blockquote>
<p>伟大的问题来了又去，希望我也能抓住一两个。</p>
</body>
<script type="text/javascript">
  "use strict";
  var gdp;
  d3.json("/assets/gdp_pisa.json", function(json) { gdp = json; });
  slide7();

  function slide7() {
      d3.select('#pisa')
          .append('div')
          .attr("class", "container")
          .attr('id', 'slide7');

      // Draw interactive map
      d3.json("/assets/world_map.json", draw);

      function draw(geo_data) {
        var margin = 5;
        var width = document.getElementById('pisa').offsetWidth;
        var height = 300 - margin;


        var zoom = d3.behavior.zoom()
            .scaleExtent([1, 9])
            .on("zoom", zoomed);

        var color = d3.scale.quantize()
            .domain([0, 100000])
            .range(colorbrewer.Spectral[10]);

        var color_fill = function (cnt) {
            if (gdp[cnt.properties.name]) {
                              return color(gdp[cnt.properties.name]); }
            else { return "white"; }
        }

        d3.select('#slide7')
            .append('div')
            .attr('id', 'map-container');

        d3.select('#map-container')
            .append("div")
            .attr("id", "legend-title")
            .text('人均GDP(k$)：');

        var legend = d3.select('#map-container')
            .append("div")
            .attr("id", "legend-menu")
            .append('ul')
            .attr('class', 'list-inline');

        var select = d3.select("#legend-menu")
            .append("select")
            .on("change", change);

        function change() {
            var selectedIndex = select.property('selectedIndex');
            var cnt = options[0][selectedIndex].__data__;
            d3.select("#box-plots").remove();
            plot_boxes(cnt, "#map-container");
        }

        var options = select.selectAll('option')
            .data(d3.keys(gdp))
            .enter()
            .append("option")
            .text(function(d) { return d; });

        // legend.append('li')
        //     .style('border-top-color', "white")
        //     .attr('id', 'legend_name')
            // .text("人均GDP(K$):");

        legend.selectAll('li.key')
            .data(color.range())
            .enter()
            .append('li')
            .attr('class', 'key')
            .style('border-top-color', String)
            .text(function(d) {
                var r = color.invertExtent(d);
                return r[1] / 1000;
            });

        var maptip = d3.select("#map-container")
            .append("div")
            .attr("id", "maptip");

        var svg_map = d3.select("#map-container")
            .append("div")
            .attr("id", "world-map")
            .append("svg")
            .attr("id", "svg-map")
            .attr("width", width + margin)
            .attr("height", height + margin)
            .append('g')
            .attr('id', 'map');

        var center = d3.geo.centroid(geo_data)
        var scale  = 150;
        var offset = [width/2, height/2];
        var projection = d3.geo.mercator().scale(scale).center(center)
            .translate(offset);


        var path = d3.geo.path().projection(projection);

      // using the path determine the bounds of the current map and use
      // these to determine better values for the scale and translation
        var bounds  = path.bounds(geo_data);
        var hscale  = scale*width  / (bounds[1][0] - bounds[0][0]);
        var vscale  = scale*height / (bounds[1][1] - bounds[0][1]);
        var scale   = (hscale < vscale) ? hscale : vscale;
        var offset  = [width - (bounds[0][0] + bounds[1][0])/2,
                          height - (bounds[0][1] + bounds[1][1])/2];
        projection = d3.geo.mercator().center(center)
          .scale(scale).translate(offset);
        path = path.projection(projection);

        var map = svg_map.selectAll('path')
                     .data(geo_data.features)
                     .enter()
                     .append('path')
                     .attr('d', path)
                     .style('fill', color_fill)
                     .style('stroke', 'black')
                     .style('stroke-width', 0.8)
                     .on("mouseover", function(d) {
                          d3.select(this)
                              .style("fill", "yellow");
                          return maptip.html(
                                           "<strong>" + d.properties.name + "</strong>" + "<br/>" +
                                              "GDP per capita: $" + Math.round(gdp[d.properties.name]))
                                        .style("visibility", "visible");})
                     .on("mousemove", function(){
                          return maptip.style("top", (d3.event.pageY-10)+"px")
                                        .style("left",(d3.event.pageX+10)+"px");
                                      })
                     .on("mouseout", function(){
                          d3.select(this)
                              .style("fill", color_fill);
                          return maptip.style("visibility", "hidden");})
                     .on("click", clicked)
                     .call(zoom);
        // map.style('transform', 'translateX(' + -width/8 +'px)');
        function zoomed() {
          map.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
        }

        function clicked(cnt) {
          d3.select("#box-plots").remove();

          if (d3.keys(gdp).indexOf(cnt.properties.name) !== -1) {
              var cnt = cnt.properties.name;
              plot_boxes(cnt, "#map-container");
          }
        }
      }
  }

  // Plot box plots for all five factors
  function plot_boxes(cnt, selection) {
    d3.select(selection)
      .append("div")
      .attr("id", "box-plots")

    d3.select("#box-plots").append("h3")
      .text(cnt + '的财富效果' +
            " (人均GDP: $" + Math.round(gdp[cnt]) + ")");

    var box = d3.select("#box-plots").selectAll("div")
      .data(['bathroom', 'car', 'cell', 'pc', 'tv'])
      .enter()
      .append("div")
      .attr("class", "box-plot")
      .attr("id", function(d) { return d });

    var boxtip = d3.select("#box-plots")
                  .append("div")
                  .attr("id", "boxtip");

    box_plot('bathroom');
    box_plot('car');
    box_plot('tv');
    box_plot('cell');
    box_plot('pc');

    // Add axis labels
    d3.select(".box-plot svg g")
        .append("text")
        .attr("text-anchor", "middle")
        .attr("transform", "translate(" + (- 35) + "," + 100 + ") rotate(-90)")
        .text("Score");

    // Plot the box plot for a certain factor
    function box_plot(factor) {

      var width = document.getElementsByClassName('box-plot')[0].offsetWidth;
      var height = 160;
      var margin = 50;

      var x = d3.scale.ordinal()
          .rangeRoundBands([0, width], .1);

      var x1 = d3.scale.ordinal();

      var y = d3.scale.linear()
          .range([height, 0]);

      var color = d3.scale.ordinal()
          .range(["#80B1D3", "#fb8072", "#fdb462"]);

      var xAxis = d3.svg.axis()
          .scale(x)
          .tickSize([0])
          .orient("bottom");

      var yAxis = d3.svg.axis()
          .scale(y)
          .orient("left");

      var lab_dict = {"None": "0", "One": "1", "Two": "2", "Three or more": "≥3"};

      var xAxis_bot = d3.svg.axis()
          .scale(x1)
          .orient("bottom")
          .tickFormat(function(d) { return lab_dict[d]; })
          .tickSize([0])
          .tickPadding(8);


      var svg = d3.select("#" + factor)
          .append("svg")
          .attr("width", width + margin)
          .attr("height", height + margin + 50)
          .attr("class", "box-svg")
          .append("g")
          .attr("transform", "translate(" + margin + "," + margin + ")");

      // Load quantiles of scores for countries
      d3.json("/assets/data.json", function(error, json) {
          if (error) return console.warn(error);

          var data = json[cnt][factor];

          var y_max = 0;
          for (var s in data){
              for (var m in data[s]){
                  var tmp = data[s][m]["Maximum"];
                  if (tmp > y_max) {y_max = tmp;}
          }}
          y_max = Math.floor(y_max/100 + 2) * 100;

          color.domain(["Maths", "Reading", "Science"]);

          x.domain(["Maths", "Science", "Reading"]);
          x1.domain(["None", "One", "Two", "Three or more"]).rangeRoundBands([0, x.rangeBand()]);
          y.domain([0, y_max]).nice();

          svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + 0 + ")")
            .call(xAxis);

          svg.append("g")
            .attr("class", "y axis")
            .call(yAxis);

          svg.append("g")
            .attr("class", "xbottom axis")
            .attr("transform", "translate(" + 0.35 * x1.rangeBand() + "," + height + ")")
            .call(xAxis_bot);

          var displacement = (x.range()[1] - x.range()[0]) + 0.35 * x1.rangeBand();
          svg.append("g")
            .attr("class", "xbottom axis")
            .attr("transform", "translate(" + displacement + "," + height + ")")
            .call(xAxis_bot);

          displacement = 2 * (x.range()[1] - x.range()[0]) + 0.35 * x1.rangeBand();
          svg.append("g")
            .attr("class", "xbottom axis")
            .attr("transform", "translate(" + displacement + "," + height + ")")
            .call(xAxis_bot);

          var subject = svg.selectAll(".subject")
              .data(d3.entries(data))
              .enter().append("g")
              .attr("class", "g_poss")
              .attr("transform", function(d) { return "translate(" + x(d.key) + ",0)"; })
              .style("stroke", function(d) { return color(d.key); });

          // Make the box
          subject.selectAll(".box")
              .data(function(d) { return d3.entries(d.value); })
              .enter().append("rect")
              .attr("class", "med_box")
              .attr("x", function(d) { return x1(d.key)})
              .attr("width", x1.rangeBand() * 0.8)
              .attr("y", function(d) { return y(d.value["Third quantile"]); })
              .attr("height", function(d) { return y(d.value["First quantile"]) - y(d.value["Third quantile"]); })
              .style("stroke-width", 1.5)
              .style("fill", "white")
              .on("mouseover", function(d) {
                   return boxtip.html(
            "<strong>Minimum: </strong> <span style='color: #66ccff'>" + d.value["Minimum"] +
            "</span></br><strong>1st quantile: </strong> <span style='color: #66ccff'>" + d.value["First quantile"] +
            "</span></br><strong>Median: </strong> <span style='color: #66ccff'>" + d.value["Median"] +
            "</span></br><strong>3rd quantile: </strong> <span style='color: #66ccff'>" + d.value["Third quantile"] +
            "</span></br><strong>Maximum: </strong> <span style='color: #66ccff'>" + d.value["Maximum"] )
                                 .style("visibility", "visible");})
              .on("mousemove", function(){
                   return boxtip.style("top", (d3.event.pageY-10)+"px")
                                 .style("left",(d3.event.pageX+10)+"px");
                              })
              .on("mouseout", function(){
                   return boxtip.style("visibility", "hidden");});

          // Make the median line
          subject.selectAll(".median")
              .data(function(d) { return d3.entries(d.value); })
              .enter().append("line")
              .attr("class", "median")
              .attr("x1", function(d) { return x1(d.key)})
              .attr("x2", function(d) { return x1(d.key) + 0.8 * x1.rangeBand()})
              .attr("y1", function(d) { return y(d.value["Median"]); })
              .attr("y2", function(d) { return y(d.value["Median"]); })
              .style("stroke-width", 1.5);

          // Make the minimum line
          subject.selectAll(".min")
              .data(function(d) { return d3.entries(d.value); })
              .enter().append("line")
              .attr("class", "min")
              .attr("x1", function(d) { return x1(d.key) + 0.1 * x1.rangeBand()})
              .attr("x2", function(d) { return x1(d.key) + 0.7 * x1.rangeBand()})
              .attr("y1", function(d) { return y(d.value["Minimum"]); })
              .attr("y2", function(d) { return y(d.value["Minimum"]); })
              .style("stroke-width", 2);

          // Make the maximum line
          subject.selectAll(".max")
              .data(function(d) { return d3.entries(d.value); })
              .enter().append("line")
              .attr("class", "max")
              .attr("x1", function(d) { return x1(d.key) + 0.1 * x1.rangeBand()})
              .attr("x2", function(d) { return x1(d.key) + 0.7 * x1.rangeBand()})
              .attr("y1", function(d) { return y(d.value["Maximum"]); })
              .attr("y2", function(d) { return y(d.value["Maximum"]); })
              .style("stroke-width", 2)

          // Make the vertical line
          subject.selectAll(".lower_vert")
              .data(function(d) { return d3.entries(d.value); })
              .enter().append("line")
              .attr("class", "vertical")
              .attr("x1", function(d) { return x1(d.key) + 0.4 * x1.rangeBand()})
              .attr("x2", function(d) { return x1(d.key) + 0.4 * x1.rangeBand()})
              .attr("y1", function(d) { return y(d.value["Minimum"]); })
              .attr("y2", function(d) { return y(d.value["First quantile"]); })
              .style("stroke-width", 1.5)
              .style("stroke-dasharray", "4, 4");

          subject.selectAll(".upper_vert")
              .data(function(d) { return d3.entries(d.value); })
              .enter().append("line")
              .attr("class", "vertical")
              .attr("x1", function(d) { return x1(d.key) + 0.4 * x1.rangeBand()})
              .attr("x2", function(d) { return x1(d.key) + 0.4 * x1.rangeBand()})
              .attr("y1", function(d) { return y(d.value["Maximum"]); })
              .attr("y2", function(d) { return y(d.value["Third quantile"]); })
              .style("stroke-width", 1.5)
              .style("stroke-dasharray", "4, 4");

          svg.append("text")
              .attr("text-anchor", "middle")
              .attr("transform", "translate(" + (width/2) + "," + (- 10) + ")")
              .text(factor);

          svg.append("text")
              .attr("text-anchor", "middle")
              .attr("transform", "translate(" + (width/2) + "," +(height + margin - 5) +")")
              .text("Number of possession");
    });}
  }
</script>
</html>
